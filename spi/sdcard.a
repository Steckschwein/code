*=$1000
!src "../bios/defs.h.a"
!src "../bios/bios.h.a"
; sdcard pin assignment:
; SD   | Signal | VIA Port B
;   1  |    /CS |          1
;   2  | CMD/DI |          6
;   5  |    CLK |	   0
;   7  | DAT/DO |          7

	sei
	lda #%01111111
	sta via1ddrb
	lda #%00111101
	sta via1portb

wait74
	ldx #74

-	dec via1portb
	nop
	inc via1portb

	dex
	bne -

	

	ldx #$00
-	lda cmd0,x
	jsr spibyte
	inx
	cpx #$06
	bne -

	;lda #%01000001
	;ora via1portb
;	sta via1portb


;	ldx #$00
;-	lda cmd58,x
;	jsr spibyte
;	inx
;	cpx #$06
;	bne -

;	lda #%01000000
;	ora via1portb
;	sta via1portb
	jmp wait74

loop
	dec via1portb
	nop
	inc via1portb
	nop
	jmp loop	
	

spibyte	
	pha
	phx
	phy
	ldx #$08
	clc
--
	
	ror
	tay
	bcs one

zero	
	lda #%10111111
	and via1portb
	sta via1portb
	bra clk

one	lda #%01000000
	ora via1portb	
	sta via1portb
	
clk
	dec via1portb
	tya
	inc via1portb

	dex
	bne --
	ply
	plx
	pla
	rts
; cmd0 reset card to SPI mode
cmd0	!byte %01000000, %00000000, %00000000, %00000000, %00000000, %10010101
; cmd58 requests the contents of the operating conditions register for the connected card
cmd58	!byte %01111010, %00000000, %00000000, %00000000, %00000000, %01110101