*=$1000
	jmp main
	
!src <defs.h.a>
!src <bios.h.a>
!src <macro.h.a>
!src <kernel.h.a>
!src <via.h.a>
!src <joystick.h.a>
!src <t99xx.lib.a>
	
.frame_cnt=tmp0
.seed=tmp1
.sin_tab_ptr=tmp2
.BLANK=74
.A_GX_SCR=$1800
.A_GX_COL=$1c80
.A_GX_PAT_1=$0000
.A_GX_PAT_2=$0800
.A_SP_PAT=$1000
.A_SP_ATR=$1c00
.screen=$2000
.dinosaur_color=Dark_Green
.DINOSAUR_Y=125

main:
	sei
	jsr	.init_via
	jsr	vdp_display_off
	jsr	.init_vram

	jsr	.init_screen
	
	lda	#33
	sta	.seed
	
	jsr	.update_vram

	+SetVector	.game_isr, irqvec
	
	lda	#Light_Blue
	sta	.adrl		;set character color
	ldx	#$20
	lda	#<.A_GX_COL
	ldy	#.WRITE_ADDRESS + >.A_GX_COL	;color vram
	jsr	vdp_fills
	
	lda	#$d0					;sprites off, at least y=$d0 will disable the sprite subsystem
	sta	.adrl
	ldx	#32*4
	lda	#<.A_SP_ATR
	ldy	#.WRITE_ADDRESS + >.A_SP_ATR
	jsr	vdp_fills
	
	+SetVector .vdp_init_gfx, .adrl
	jsr	vdp_init_reg
	
	cli
	
-	
	bra	-

.vdp_init_gfx
	!byte 	0
	!byte	v_reg1_16k|v_reg1_display_on|v_reg1_spr_size|v_reg1_int
	!byte 	(.A_GX_SCR / $400)	; name table - value * $400					--> characters 
	!byte 	(.A_GX_COL /  $40)	; color table - value * $40 (gfx1), 7f/ff (gfx2)
	!byte 	(.A_GX_PAT_1 / $800) ; pattern table (charset) - value * $800  	--> offset in VRAM 
	!byte	(.A_SP_ATR / $80)	; sprite attribute table - value * $80 		--> offset in VRAM
	!byte 	(.A_SP_PAT / $800)  ; sprite pattern table - value * $800  		--> offset in VRAM
	!byte	Light_Blue

.init_via
	;via port a
	lda #$00
	sta via1ier             ; disable VIA1 T1 interrupts
	lda #%00000000 			; set latch
	sta via1acr
	lda #%11001100 			; set level
	sta via1pcr
	lda #%11000000 			; set PA6,7 to output (port select), PA1-5 to input (directions)
	sta via1ddra
	rts 
	
.init_screen
	ldx	#$00
-	lda	.game_char_tab,x
	sta	.screen,x
	inx
	cpx	#32*4
	bne	-
	rts
	
.scroll_background
	rts
	lda	.screen
	sta	.screen+128
	lda	.screen+32
	sta	.screen+128+1
	lda	.screen+64
	sta	.screen+128+2
	lda	.screen+96
	sta	.screen+128+3
	
	ldx	#$00
-	lda	.screen+1,x
	sta	.screen,x
	lda	.screen+32+1,x
	sta	.screen+32,x
	lda	.screen+64+1,x
	sta	.screen+64,x
	lda	.screen+96+1,x
	sta	.screen+96,x
	inx	
	cpx	#32
	bne	-
	lda	.screen+128
	sta	.screen+31
	lda	.screen+128+1
	sta	.screen+31+32
	lda	.screen+128+2
	sta	.screen+31+64
	lda	.screen+128+3
	sta	.screen+31+96
	
	rts

.animate_dinosaur
	lda	.frame_cnt
	and	#3
	bne	++
;	sin
;	inc	.sprite_tab
;	inc	.sprite_tab+1*4
;	inc	.sprite_tab+2*4
;	inc	.sprite_tab+3*4
	
	lda	.sprite_tab+2*4+2
	cmp	#$08
	beq	+
	lda	#08
	sta	.sprite_tab+2*4+2
	lda	#12
	sta	.sprite_tab+3*4+2
++	rts	
+	lda	#16
	sta	.sprite_tab+2*4+2
	lda	#20
	sta	.sprite_tab+3*4+2
	rts

.animate_sky
	ldx	#$00
-	dec	.sprite_tab_sky+1,x
	bne	++
	lda	.sprite_tab_sky+3,x
	tay
	and	#Sprite_EC
	bne	+
	tya	
	ora	#Sprite_EC
	sta	.sprite_tab_sky+3,x
	lda	#32
	sta .sprite_tab_sky+1,x
	bra	++
+	tya
	and	#<!Sprite_EC
	sta	.sprite_tab_sky+3,x
	lda	#$ff
	sta .sprite_tab_sky+1,x
++	inx
	inx
	inx
	inx
	cpx	#32
	bne	-
	rts
	
.game_isr
	bit	a_vreg
	bpl	.game_isr_exit
	+save
	
;	lda	#Dark_Yellow
;	jsr	vdp_bgcolor

	jsr	.animate_dinosaur
	jsr	.animate_sky
			
	lda	.frame_cnt
	and	#$03
	bne	+
	jsr	.scroll_background
+			
	jsr	.update_vram

	jsr	.action_handler
	
;	jsr keyin
	cmp	#$20
	bne	+
	lda	White
	jsr	vdp_bgcolor
+
	
	inc	.frame_cnt
;	inc	
;	cmp	#50
;	bne	+
;	lda	#0
;+	sta	.frame_cnt

	lda	#Black
	jsr	vdp_bgcolor
	
	+restore
.game_isr_exit	
	rti
	
.action_handler
	lda	#PORT_SEL_2		;port 1
	sta	via1porta
	nop
	nop
	nop
	nop
	lda	via1porta
	and #JOY_UP
	bne	+
	dec	.sprite_tab
	dec	.sprite_tab+1*4
	dec	.sprite_tab+2*4
	dec	.sprite_tab+3*4
+	
	lda	via1porta
	and #JOY_DOWN
	bne	++
	ldx	.sin_tab_ptr
	lda	.sin_tab,x
	clc	
	adc	#.DINOSAUR_Y
	sta	.sprite_tab
;	sta	.sprite_tab+1*4
	sta	.sprite_tab+2*4
;	sta	.sprite_tab+3*4
	inx	
	cpx	#46
	bne	+
	ldx	#$00
+	stx	.sin_tab_ptr
++
	rts
	
		
.init_vram
	stz	.frame_cnt

	ldx	#$03
	lda	#.BLANK					;fill vram screen with blank
	sta	.adrl
	lda	#<.A_GX_SCR
	ldy	#.WRITE_ADDRESS + >.A_GX_SCR
	jsr	vdp_fill

	+SetVector charset, .adrl
	lda #<.A_GX_PAT_1
	ldy #.WRITE_ADDRESS + >.A_GX_PAT_1
	ldx	#$08
	jsr	vdp_memcpy
	lda #<.A_GX_PAT_2
	ldy #.WRITE_ADDRESS + >.A_GX_PAT_2
	ldx	#$08
	jsr	vdp_memcpy
	
	+SetVector .game_chars, .adrl
	lda #<.A_GX_PAT_1
	ldy #.WRITE_ADDRESS + >.A_GX_PAT_1
	ldx	#$03
	jsr	vdp_memcpy
	
	+SetVector .game_chars_4px, .adrl
	lda #<.A_GX_PAT_2
	ldy #.WRITE_ADDRESS + >.A_GX_PAT_2
	ldx	#$03
	jsr	vdp_memcpy
	
	+SetVector .sprites, .adrl
	lda	#<.A_SP_PAT
	ldy	#.WRITE_ADDRESS + >.A_SP_PAT
	ldx	#$02
	jsr	vdp_memcpy
	
	+PrintStringAt .text_game_label, 0, 22
	
	rts
	
.update_vram
	+SetVector .sprite_tab, .adrl
	lda	#<.A_SP_ATR
	ldy	#.WRITE_ADDRESS + >.A_SP_ATR
	ldx	#12*4
	jsr	vdp_memcpys
	
	+SetVector .screen, .adrl
	lda	#<(.A_GX_SCR + (16*32))
	ldy	#.WRITE_ADDRESS + >(.A_GX_SCR+(16*32))
	ldx	#32*4
	jmp	vdp_memcpys
	
	rts

.rnd:
   lda .seed
   beq .doEor
   asl
   beq .noEor ;if the input was $80, skip the EOR
   bcc .noEor
.doEor:    
	eor #$1d
.noEor:  
	sta .seed
	rts

.sprite_tab
	!byte	.DINOSAUR_Y,		32,0, .dinosaur_color
	!byte	.DINOSAUR_Y+16,	32,4, .dinosaur_color
	!byte	.DINOSAUR_Y,16,	8, .dinosaur_color	;0100 ->  1000
	!byte	.DINOSAUR_Y+16,	16,12, .dinosaur_color  ;1100 -> 10100
.sprite_tab_sky
	!byte	40,100,36, White
	!byte	40,116,40, White
	!byte	56,30,36, White
	!byte	56,46,40, White
	!byte	72,70,36, White
	!byte	72,86,40, White
	!byte	98,200,36, White
	!byte	98,216,40, White

.text_game_label	!text "verbindung zum internet konnte  nicht hergestellt werden.",$0
.text_game_over	!text "GAME OVER",$0
.text_HI			!text "HI ",$0

.sprites
+SpriteLine16start
!src "dinosaur.sprites.a"

.game_char_tab
	!byte 74, 0, 4, 74, 74, 74, 74, 74, 74, 74, 74, 0, 26, 30, 34, 38, 42, 74, 74, 47, 51, 55, 59, 74, 74, 74, 74, 74, 32, 74, 74, 74
	!byte 74, 1, 5, 74, 74,  9, 12, 15, 18, 74, 74, 1, 27, 31, 35, 39, 43, 74, 74, 48, 52, 56, 60, 74, 74, 74, 74, 74, 74, 74, 74, 74
	!byte 74, 2, 6, 74, 74, 10, 13, 16, 19, 74, 74, 2, 28, 32, 36, 40, 44, 74, 74, 49, 53, 57, 61, 74, 74, 65, 67, 69, 71, 74, 74, 74
	!byte 74, 3, 7,  8, 74, 11, 14, 17, 20, 21, 74, 3, 29, 33, 37, 41, 45, 46, 74, 50, 54, 58, 62, 21, 74, 68, 70, 72, 74, 74, 74, 74
	
.game_chars
!src "dinosaur.chars.1.res"
!src "dinosaur.chars.2.res"
!src "dinosaur.chars.3.res"
!src "dinosaur.chars.4.res"
!src "dinosaur.chars.5.res"
!src "dinosaur.chars.6.res"
.game_chars_4px
!src "dinosaur.chars.1.4px.res"
!src "dinosaur.chars.2.4px.res"
!src "dinosaur.chars.3.4px.res"
!src "dinosaur.chars.4.4px.res"
!src "dinosaur.chars.5.4px.res"
!src "dinosaur.chars.6.4px.res"

!fill 255,0
.sin_tab
	!for i, 0, 45 {
		!byte sin(i*4)*32
	}