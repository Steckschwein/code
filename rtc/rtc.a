*=$1000
!src "../bios/defs.h.a"
!src "../bios/bios.h.a"

	lda #dev_lcd
    sta chn_out

    ; Set IRQ Vector
    lda #<read
    sta irqvec

    lda #>read
    sta irqvec+1


	jsr lcdclear
    
	+PrintString time_mask

	ldx #$00
	ldy #$02
	jsr lcdxy
	+PrintString date_mask


	jsr rtc_enable
	lda #$8f
	jsr spi_rw_byte
	lda #$01
	jsr spi_rw_byte
	jsr rtc_disable

	jsr rtc_enable
	lda #$87
	jsr spi_rw_byte
	lda #$81
	jsr spi_rw_byte
	lda #$80
	jsr spi_rw_byte
	lda #$80
	jsr spi_rw_byte
	lda #$80
	jsr spi_rw_byte
	jsr rtc_disable

	cli
	;jsr read

-	jmp -

read
	pha
	jsr rtc_enable
    lda #$07
	jsr spi_rw_byte
	jsr rtc_disable

	jsr rtc_enable
    lda #$00
   	jsr spi_rw_byte

	ldx #$06
    ldy #$01
    jsr lcdxy

    jsr spi_r_byte
    jsr hexout	

	ldx #$03
	ldy #$01
    jsr lcdxy

    jsr spi_r_byte
    jsr hexout	

	ldx #$00
	ldy #$01
    jsr lcdxy

    jsr spi_r_byte
    jsr hexout	


    jsr spi_r_byte

	ldx #$00
	ldy #$02
    jsr lcdxy

	jsr spi_r_byte
	jsr hexout	

	ldx #$03
	ldy #$02
    jsr lcdxy

	jsr spi_r_byte
	jsr hexout	

	ldx #$06
	ldy #$02
    jsr lcdxy
	
	jsr spi_r_byte
	jsr hexout	

	
	jsr rtc_disable
	pla
	rti

write 
	pha

	ldx #$00

	jsr rtc_enable

    lda #$a0
    jsr spi_rw_byte

-   lda text,x
    beq +
    phx
    jsr spi_rw_byte
    plx
    inx
    bra -

+   jsr rtc_disable
    
    jsr rtc_enable

    lda #$80
    jsr spi_rw_byte
    
    lda #$30
    jsr spi_rw_byte
    lda #$24
	jsr spi_rw_byte
	lda #$22
	jsr spi_rw_byte
	jsr rtc_disable
    pla
    rts

write_date
	pha
	jsr rtc_enable

    lda #$83
    jsr spi_rw_byte
    lda #$06
    jsr spi_rw_byte

    lda #$22
    jsr spi_rw_byte
    lda #$12
    jsr spi_rw_byte
    lda #$14
    jsr spi_rw_byte

	jsr rtc_disable


	pla
	rts


rtc_disable
	pha

	lda #$80
	ora kbd_flg
	sta kbd_flg
	; Deselect any SPI devices
	lda #%11111110
	sta via1portb
	
	pla
	rts

rtc_enable
	pha
	; Select SPI SS for keyboard
	lda #%01110110
	; and via1portb
	sta via1portb

	pla
	rts

text	!text "Hallo!", $00
time_mask !text "00:00:00", $00
date_mask !text "00.00.00", $00
