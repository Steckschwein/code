*=$1000
!src <defs.h.a>
!src <via.h.a>
!src <bios.h.a>


main
    sei
 	;   Set IRQ Vector
 	+SetVector isr, irqvec

    
	jsr rtc_enable

	lda #$87
	jsr spi_rw_byte
	lda #$80
	jsr spi_rw_byte
	lda #$80
	jsr spi_rw_byte
	lda #$80
	jsr spi_rw_byte
	lda #$80
	jsr spi_rw_byte

	jsr rtc_disable

	jsr rtc_enable
	lda #$8f
	jsr spi_rw_byte
	lda #$01
	jsr spi_rw_byte
	jsr rtc_disable
	cli

    lda #'A'
    jsr chrout
    
    
-	bra -

isr
	pha



	; read status register. irq from rtc?
	jsr rtc_enable
	lda #$10
	jsr spi_rw_byte
	jsr spi_r_byte
	jsr rtc_disable
	cmp #$01
	bne + ; no, get out

	
	
	; acknowledge RTC ALARM0 interrupt 
	jsr rtc_enable

	lda #$87
	jsr spi_rw_byte
	jsr spi_r_byte
	jsr rtc_disable


    lda #'X'
    jsr chrout
    
+	pla
	rti

rtc_disable
	pha

	; Deselect any SPI devices
	lda #%11111110
	sta via1portb
	
	pla
	rts

rtc_enable
	pha
	; Select SPI SS for keyboard
	lda #%01110110
	; and via1portb
	sta via1portb

	pla
	rts

; text	!text "Hallo!", $00
time_mask !text "00:00:00", $00
date_mask !text "00.00.00", $00

!src <t99xx.lib.a>