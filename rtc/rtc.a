*=$1000
!src <defs.h.a>
!src <via.h.a>
!src <bios.h.a>
!src <t9929.h.a>

tsec = tmp6
tmin = tmp5
thou = tmp4
tday = tmp3
tmon = tmp2
tyea = tmp1
	jmp main
main
    sei
 	;   Set IRQ Vector
 	+SetVector isr, irqvec

   	lda #50
	sta tmp7

	+Println
    
	jsr rtc_enable
	lda #$8f
	jsr spi_rw_byte
	lda #$00
	jsr spi_rw_byte
	jsr rtc_disable

	cli
    
    jsr isr
    rts
-	bra -

isr
	pha
	phy
	phx

    lda #10
    jsr chrout
    
	lda #50
	sta tmp7

	lda #24
	sta crs_x
	stz crs_y

	; jsr read
	jsr rtc_enable
    lda #$00
   	jsr spi_rw_byte

    jsr spi_r_byte
    sta tsec
    jsr spi_r_byte
    sta tmin
    jsr spi_r_byte
    sta thou

    jsr spi_r_byte

    jsr spi_r_byte
    sta tday
    jsr spi_r_byte
    sta tmon
    jsr spi_r_byte
    sta tyea
	jsr rtc_disable

	lda thou
	jsr hexout
    lda #':'
    jsr chrout
	lda tmin
	jsr hexout
    lda #':'
    jsr chrout
	lda tsec
	jsr hexout

    lda #' '
    jsr chrout
    
	lda tday
	jsr hexout
    lda #'.'
    jsr chrout
	lda tmon
	jsr hexout
    lda #'.'
    jsr chrout
	lda tyea
	jsr hexout

+	pla
	ply	
	plx
	rts

rtc_disable
	pha

	; Deselect any SPI devices
	lda #%11111110
	sta via1portb
	
	pla
	rts

rtc_enable
	pha
	; Select SPI SS for keyboard
	lda #%01110110
	; and via1portb
	sta via1portb

	pla
	rts

; text	!text "Hallo!", $00
time_mask !text "00:00:00", $00
date_mask !text "00.00.00", $00

!src <t99xx.lib.a>