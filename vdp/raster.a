*=$1000
    jmp main
!src <defs.h.a>
!src <macro.h.a>
!src <t99xx.lib.a>
!src <via.h.a>

main
    sei
    
    +SetVector  .raster_irq, irqvec
    
    lda #Cyan<<4
    jsr vdp_mode_gfx1
    
    lda #%11000000
	sta via1ier             ; enable VIA1 T1 interrupts
    cli
-   bra -

.raster_irq
    pha
    
    bit a_vreg
    bpl +
    jsr .via_timer_blank
    lda #60
    sta tmp0        ;30 raster lines
    lda #Gray
    bra +++
    
+	bit via1ifr		; Interrupt from VIA?
	bpl ++
	bit via1t1cl	; Acknowledge timer interrupt
    dec tmp0
    beq ++
    lda #<(32*1000 / 250)
	sta via1t1cl            ; set low byte of count
	lda #>(32*1000 / 250)
	sta via1t1ch            ; set high byte of count
    lda tmp0
    bra +++
    
++   lda #Light_Blue
+++
    jsr vdp_bgcolor
    
;    lda #Black
 ;   jsr vdp_bgcolor
    
    pla
    rti
    
.via_timer_blank
    ; 4300µs --> 4Mhz/250ns --> 4.300.000ns / 250ns =  17200
    blank_counter=2*(4300 * 1000) / 250
	lda #<blank_counter
	sta via1t1cl            ; set low byte of count
	lda #>blank_counter
	sta via1t1ch            ; set high byte of count
    rts