*=$1000

jmp init
!src "../bios/defs.h.a"
!src "../bios/bios.h.a"
!src "../vdp/t9929.h.a"
!address {
txtbuf=$0300	
}
crsr_blinkrate = $0f
init
	sei

	stz chn_in
  	stz chn_out

  	lda #crsr_blinkrate
  	sta tmp7
  	
  	stz tmp6


	+SetVector isr, irqvec

	lda	#v_reg1_16k|v_reg1_display_on|v_reg1_int
	ldy	#v_reg1
	jsr	vdp_sreg

	cli
	jsr lcdclear


main

  	; stz chn_out
	ldx #$00
	stx crs_x

	stx txtbuf

	+PrintString text1

	; ldx #$00
	; ldy #$02
	; jsr lcdxy

	
	; ldx #$00

-	jsr chrin
	
	cmp #$0c
	beq +

	cmp #$0d ; return gedrueckt?
	beq out

	cmp #$08 ; Backspace
	bne ++
	lda #' '
	pha
	jsr		vdp_set_addr
	pla
	+nops 	VRAM_WAIT
	sta		a_vram
	dec crs_x
	dex
	stz txtbuf,x
	bra -
++	pha
	jsr chrout
	pla




	sta txtbuf,x
	inx
	stz txtbuf,x
	cpx #$0f
	beq out


	jmp -
+	
	;jsr lcdclear
	jmp -

out 
	lda #' '
	pha
	jsr		vdp_set_addr
	pla
	+nops 	VRAM_WAIT
	sta		a_vram

	lda txtbuf
	beq +
	jsr crlf
	;jsr lcdclear
	+PrintString  text2
	+PrintString  txtbuf
	jsr crlf

; --	jsr chrin
; 	cmp #$0d
; 	bne --
	jsr crlf
	jmp main
+
	jsr crlf
	+PrintString name
	jsr crlf
	jmp main

reset
	jmp ($fffc)

text1	!text "Wie heisst du? ", $00
text2	!text "Hallo, ", $00
name	!text "Bitte gib deinen Namen ein.", $00

!src "../vdp/t99xx.lib.a"

crlf
	stz crs_x
	inc crs_y
	rts

; vdp_cursor: 
;    pha
;    phy

;    lda   #$20
;    ldy   #$54
;    jsr   vdp_sreg
;    lda   crs_x
;    and   #$10
;    beq   +
;    lda   #231
;    jmp   ++
; +  lda   #' '
; ++ sta   a_vram
;    ; inc   crs_x
   
;    pla
;    ply

;    rts


isr
	pha
	bit	a_vreg ; Check VDP interrupt. IRQ is acknowledged by reading.
	bpl +	   ; VDP IRQ flag set? 
			   ; then do stuff here

	dec tmp7   ;
	bne +

  	lda #crsr_blinkrate
  	sta tmp7

	; jsr home

  	lda tmp6
  	beq ++
	
	lda   #231
	; lda #'X'
	stz tmp6
	jmp xyz
++
	inc tmp6
	lda #' '
	
xyz	
	pha
	jsr		vdp_set_addr
	pla
	+nops 	VRAM_WAIT
	sta		a_vram

+			   ; or not
	pla
	rti

