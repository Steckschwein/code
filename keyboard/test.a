*=$1000
!src "../bios/defs.h.a"
!src "../bios/bios.h.a"

txtbuf=$0300
buffer = $0280 ; kbd buffer in reserved ram within io space. :-)
ptr  = tmp7

	lda #$00
	sta ptr


	lda #dev_lcd
	sta chn_out

	; Select SPI SS for keyboard
	; lda #%11111010
	; sta via1portb


; TODO: rausfinden warum hier nur datenm√ºll kommt

; -	
; 	lda #$ff

; 	jsr spi_rw_byte
; 	beq -
;  	cmp #$ff
;  	beq - 
;  	jsr lcdprint

;  	jmp -


	sei

	; Set IRQ Vector
	lda #<kbd
	sta irqvec

	lda #>kbd
	sta irqvec+1


	lda #<count
	sta via1t1cl            ; set low byte of count
	lda #>count
	sta via1t1ch            ; set high byte of count

	lda #%11000000
	sta via1ier             ; enable VIA1 T1 interrupts

	lda #%01000000
	sta via1acr             ; T1 continuous, PB7 disabled

	cli

main
  	jsr lcdclear

	+PrintString text1
	ldx #$00
	ldy #$02
	jsr lcdxy

	ldx #$00
-	jsr getkey
	
	cmp #$0c
	beq +

	jsr chrout

	cmp #$0d ; return gedrueckt?
	beq out

	sta txtbuf,x
	inx
	stz txtbuf,x


	jmp -
+	jsr lcdclear
	jmp -

out jsr lcdclear
	+PrintString  text2
	+PrintString  txtbuf

--	jsr getkey
	cmp #$0d
	bne --
	jmp main
getkey
	phx
-	ldx ptr  
	beq -		; buffer empty, wait for key
	dex
	lda buffer, x
	stx ptr

	plx
	rts

kbd
 	pha
 	phx
 
 	; Interrupt from VIA1 timer?
 	lda #%11000000
 	bit via1ifr	
 	beq + ; no?

	; acknowledje interrupt 	
 	bit via1t1cl

 	
	ldx ptr
	cpx #$0f
	; ptr <= $0f?
	bcc ++
	beq ++

	bra +
++

	; ; Select SPI SS for keyboard
	lda #%11111010
	sta via1portb


	; lda #$ff
 	jsr spi_r_byte
	beq ++
 	cmp #$ff
 	beq ++

 	sta buffer, x
 	inc ptr

++
	; ; Deselect any SPI devices
	ldx #%11111110
	stx via1portb

	
+	pla
	plx
	rti


reset
	jmp ($fffc)


text1	!text "Wie heisst du?", $00
text2	!text "Hallo, ", $00