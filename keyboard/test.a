*=$1000
!src "../bios/defs.h.a"
!src "../bios/bios.h.a"

buffer = $0300
ptr  = tmp7

	lda #$00
	sta ptr

	lda #dev_lcd
	sta chn_out
  	jsr lcdclear

; -	
; 	jsr spi_r_byte
; 	beq -
;  	cmp #$ff
;  	beq - 
;  	jsr lcdprint
;  	jmp -

	; lda #$00
	; sta via1ddra

	sei

	; Set IRQ Vector
	lda #<kbd
	sta irqvec

	lda #>kbd
	sta irqvec+1


	lda #<count
	sta via1t1cl            ; set low byte of count
	lda #>count
	sta via1t1ch            ; set high byte of count

	lda #%11000000
	sta via1ier             ; enable VIA1 T1 interrupts

	lda #%01000000
	sta via1acr             ; T1 continuous, PB7 disabled

	;lda #%00000100
	; lda #%10001100
	; sta via1ier             ; enable VIA1 shift register


	; lda #%00001100
	; sta via1acr             ; shift register external clock


	cli
-
	jsr getkey	
	jsr chrout
	jmp -
	

getkey
	phx
-	ldx ptr  
	beq -		; buffer empty, wait for key
	dex
	lda buffer, x
	stx ptr

	plx
	rts

kbd
 	pha
 	phx
 
 	; Interrupt from VIA1 timer?
 	lda #%11000000
 	bit via1ifr	
 	beq + ; no?

	; acknowledje interrupt 	
 	bit via1t1cl


	ldx ptr
	cpx #$0f
	; ptr <= $0f?
	bcc ++
	beq ++

	bra +
++
	jsr spi_r_byte
	;lda via1porta	
	beq +
 	cmp #$ff
 	beq + 

 	sta buffer, x
 	inc ptr
	
+	pla
	plx
	rti


reset
	jmp ($fffc)