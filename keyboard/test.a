*=$1000
!src "../bios/defs.h.a"
!src "../bios/bios.h.a"

	lda #$00
	sta via1ddra

	sei

	; Set IRQ Vector
	lda #<kbd
	sta irqvec

	lda #>kbd
	sta irqvec+1


	lda #<count
	sta via1t1cl            ; set low byte of count
	lda #>count
	sta via1t1ch            ; set high byte of count

	lda #%11000000
	sta via1ier             ; enable VIA1 T1 interrupts

	lda #%01000000
	sta via1acr             ; T1 continuous, PB7 disabled

	;lda #%00000100
	; lda #%10001100
	; sta via1ier             ; enable VIA1 shift register


	; lda #%00001100
	; sta via1acr             ; shift register external clock


	cli

-
	; lda via1porta
	; beq -
	; jsr lcdprint

	jmp -
	
kbd
 	pha
 
 	; Interrupt from VIA1 timer?
 	lda #%11000000
 	bit via1ifr	
 	beq + ; no?

 	jsr keyboard
	
+	pla

	rti

keyboard
	pha
 	bit via1t1cl
 	lda via1porta
 	beq +

 	cmp #21 ; CTRL_U
	beq myupload

	cmp #12 ; CTRL_L
	bne ++
	jsr lcdclear
	bra +

++	cmp #$8e
	beq reset

	jsr lcdprint

+	pla
	rts

myupload
	lda #<upload_txt
	sta msgptr
	lda #>upload_txt
	sta msgptr+1
	jsr lcdstring

	jmp upload
upload_txt !text "Upload ready!",$00
reset
	jmp ($fffc)
