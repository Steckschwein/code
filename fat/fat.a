* = $1000
bios = 1
!src <defs.h.a>
!src <macro.h.a>
!src <bios.h.a>
!src <via.h.a>
!src <fat32.h.a>

!address {
STR             = $f6
; buf				= $2000
}

	jsr init_sdcard
	; check errno. if != 00, sd card init failed.
	; do not attempt to mount card, jump to upload instead
	lda errno
	bne .error

	lda #%01111110
	sta via1portb

	jsr .fat_mount 
	lda errno
	bne .error 


; 	+SetVector filename, filenameptr
; 	jsr .fat_open
; 	lda errno
; 	bne .error 

; 	+SetVector sd_blktarget, sd_blkptr
; 	jsr .fat_read
; 	lda errno
; 	bne .error 

; 	ldx #$00
; -	lda sd_blktarget,x 
; 	jsr chrout
; 	inx
; 	cpx #$0f
; 	bne -

; 	lda #'X'
; 	jsr chrout


; -	jmp -
	
	+SetVector filename, filenameptr

	jsr .crlf
	jsr .fat_find_first
	bcc +
	jsr .print_entry_name

-
	jsr .crlf
	jsr .fat_find_next
	bcc +
	jsr .print_entry_name
	bra -
+
	jsr .crlf	
	lda #'X'
	jsr chrout

-	jmp -

.error
	jsr hexout
-	jmp -

.print_entry_name

	ldy #DIR_Name
---	lda (dirptr),y
	jsr chrout
	iny
	cpy #$0b
	bne ---

	rts








.crlf
	lda #$0a
	jsr chrout
	lda #$0d
	jsr chrout
	rts


!src <fat.a>

filename !text "t*",$00

