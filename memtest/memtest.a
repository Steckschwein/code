*=$0300
!src "../bios/defs.h.a"
!src "../bios/bios.h.a"

main
      ; Check zeropage
check_zp      
      ; Start at $ff
      ldy #$ff
      ; Start with pattern $03 : $ff
-     ldx #$01

--    lda pattern,x
      sta $00,y
 
      cmp $00,y
      bne zp_kaputt

      dex
      bne --

      dey
      bne -

      ldx #.selfmod_end - .selfmod_start
-     lda .selfmod_start - 1, x
      sta .target - 1, x
      dex
      bne -
      stz chn_out
      jmp .target
;      jmp check_mem 

      ; Broken ZP
zp_kaputt
      txa
      jsr lcdclear
      jsr lcdhex
-     jmp -


start_check = $0300

.selfmod_start
!pseudopc $0000 {
.target
check_mem
      stz tmp1
loop      
-     ldx #$01
--    lda pattern,x
a     sta start_check   ; Start at $0200. skip stack for now      
b     cmp start_check
      bne +
      

      ; phx
      ; phy
      ; ldx #$00
      ; ldy #$00
      ; jsr lcdxy
      ; lda loop+3
      ; jsr lcdhex
      ; lda loop+4
      ; jsr lcdhex
      ; ply  
      ; plx
      
      dex 
      bne --

      inc a+1
      inc b+1
      bne loop

      inc a+2
      inc b+2
      bne loop

      

+     sta tmp0

      jsr lcdclear

      lda #'$'
      jsr chrout
      lda a+2
      jsr hexout
      lda a+1
      jsr hexout

      lda #' '
      jsr chrout
      lda #'$'
      jsr chrout
      lda tmp0 
      jsr hexout

      ;ldx #$0a
      ;ldy #$01
      ;jsr lcdxy
      
      lda tmp1
      jsr hexout

      inc tmp1

      +SetVector start_check, a+1
      +SetVector start_check, b+1

      jmp loop
}
.selfmod_end
-     jmp -
      
pattern  !byte $aa,$55
; memcheck_zp
;       !bin "memtest_zp.bin"
