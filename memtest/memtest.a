*=$0300
!src <defs.h.a>
!src <bios.h.a>
!address {
	.start_check = $0300
      .zp_pattern  = $00
}

num_patterns = 6

main	
      lda #>.start_check
      sta ram_end_h
      ldy #<.start_check
      sty ram_end_l

      ldx #num_patterns-1
-     lda .pattern,x
      sta .zp_pattern,x
      dex
      bne -

      ldx #.selfmod_end - .selfmod_start
-     lda .selfmod_start - 1, x
      sta .target - 1, x
      dex
      bne -
      jmp .target

      ; Broken ZP
.zp_kaputt
      txa
      jsr hexout
-     jmp -



.selfmod_start
!pseudopc $000f {
.target
-     ldx #num_patterns-1
--    lda .zp_pattern,x
      sta (ram_end_l),y
      cmp (ram_end_l),y
      bne +

      dex 
      bne --

      iny
      bne -

      inc ram_end_h
      bne -

      

+  
      sty ram_end_l
      lda #'$'
      jsr chrout
      lda ram_end_h
      jsr hexout
      tya
      jsr hexout

-     jmp -
}
.selfmod_end
      
.pattern  !byte $00,$ff,$aa,$55,$f0,$0f
