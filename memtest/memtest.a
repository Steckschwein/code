*=$0300
!src <defs.h.a>
!src <bios.h.a>
!address {
	start_check = $0300
}

main
      ; Check zeropage
check_zp      
      ; Start at $ff
      ldy #$ff
      ; Start with pattern $03 : $ff
-     ldx #$01

--    lda .pattern,x
      sta $00,y
 
      cmp $00,y
      bne .zp_kaputt

      dex
      bne --

      dey
      bne -
	
      lda #>start_check
      sta ram_end_h
      ldy #<start_check
      sty ram_end_l

      ldx #.selfmod_end - .selfmod_start
-     lda .selfmod_start - 1, x
      sta .target - 1, x
      dex
      bne -
      jsr .target

      ; Broken ZP
.zp_kaputt
      txa
      jsr hexout
-     jmp -



.selfmod_start
!pseudopc $0000 {
.target
-     ldx #$01
--    lda .pattern,x
      sta (ram_end_l),y
      cmp (ram_end_l),y
      bne +

      dex 
      bne --

      iny
      bne -

      inc ram_end_h
      bne -

      

+  
      sty ram_end_l
      lda #'$'
      jsr chrout
      lda ram_end_h
      jsr hexout
      tya
      jsr hexout

      rts
}
.selfmod_end
-     jmp -
      
.pattern  !byte $aa,$55
