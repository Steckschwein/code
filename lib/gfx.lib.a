!source <defs.h.a>
!src <t9929.h.a>

!macro setPixel .x, .y, .color{
	ldx	.x
	ldy	.y
	lda	.color
	jsr	set_pixel
}


.bitmask
	!byte $80,$40,$20,$10,$08,$04,$02,$01

;
; VRAM ADDRESS = 8(INT(X DIV 8)) + 256(INT(Y DIV 8)) + (Y MOD 8)
set_pixel
;	pha
	stz	.adrl
	stz .adrh	;	ADDRESS_GFX2_PATTERN = $0000, safe cycles here, by init with 0
;	+SetVector ADDRESS_GFX2_PATTERN, .adrl 
	
	; low byte vram adress
	txa
	and	#$f0
	lsr
	lsr
	lsr
;	clc			- adress low is zero, therefore we must not add
;	adc	.adrl

	sta	.adrl
	tya
	and	#$07
	clc
	adc	.adrl
	sta	.adrl			;safe vram low byte
	sta	a_vreg
	
	; high byte vram address
	tya
	lsr
	lsr
	lsr
;	clc
;	adc	#(.WRITE_ADDRESS + >ADDRESS_GFX2_PATTERN)
	sta	a_vreg
	
	sta	.adrh	;safe vram high byte
	
	txa
	and	#$07
	tax
	lda	a_vram	;read current byte 
	ora	.bitmask,x
	tax
	
	lda	.adrl
	sta a_vreg
	lda	.adrh
	clc
	adc	#.WRITE_ADDRESS
	sta	a_vreg
	txa
	sta a_vram
	
;	pla		
	rts