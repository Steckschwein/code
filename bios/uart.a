;----------------------------------------------------------------------------------------------
; init UART
;----------------------------------------------------------------------------------------------
init_uart
	; ok, we detected a 16550A, i.e. a chip 
	; with working FIFO
	lda #%10000000
	sta uart1lcr

	; ldy #param_baud
	; lda (paramvec),y
	
	; asl 
	; tax
	; ldx #19*2	; 115200 BAUD

;	ldx #17*2	; 38400 BAUD
;	ldx #15*2	; 9600 BAUD
;	ldx #11*2	; 2400 BAUD

	lda #$01
	; lda .uart_divisor,x
	sta uart1dll	


	; lda .uart_divisor+1,x
	stz uart1dlh

	; ldy #param_lsr
	; lda (paramvec),y

	lda #%00000011	; 8N1

	sta uart1lcr

	lda #$00
	sta uart1fcr	; FIFO off
	sta uart1ier	; polled mode (so far) 
	sta uart1mcr	; reset DTR, RTS

	and #%00001100			; keep OUT1, OUT2 values
	sta uart1mcr		; reset DTR, RTS
	clc

	rts


;----------------------------------------------------------------------------------------------
; send byte in A 
;----------------------------------------------------------------------------------------------
.uart_tx
	pha


-	lda uart1lsr
	and #$20
	beq -

	pla 

	sta uart1rxtx

	rts

;----------------------------------------------------------------------------------------------

;----------------------------------------------------------------------------------------------
; receive byte, store in A 
;----------------------------------------------------------------------------------------------
.uart_rx
-	lda uart1lsr 
	and #$1f
	cmp #$01
	bne -
	
	lda uart1rxtx
 
	rts