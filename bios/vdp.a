!set bios_stuff=1               ;bios stuff only
!src <t99xx.lib.a>

init_vdp
    jsr vdp_display_off         ;display off
    jsr vdp_mode_gfx1_sprites_off
    jsr vdp_mode_gfx1_blank
    
    stz crs_x
    stz crs_y
    
    +SetVector    charset, addr

    ; we always copy the charset from rom
    ; save state of memctl register
    lda memctl
    pha

    ; enable rom
    ;stz memctl  ; TODO FIXME cannot work with piggy loader, if we enable ROM we kill ourself

    lda #<ADDRESS_GFX1_PATTERN
    ldy #.WRITE_ADDRESS + >ADDRESS_GFX1_PATTERN

    ldx #$08                    ;load charset
    jsr vdp_memcpy
    
    ;restore state of memctl
    pla
    sta memctl

    lda #Cyan<<4|Black          ;enable gfx 1 with cyan on black background
    jsr vdp_mode_gfx1
    
    jsr vdp_irq_off             ;switch gfx int off
    
    rts