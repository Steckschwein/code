!src <defs.h.a>
!src <via.h.a>
!src <spi.a>

!src "../bios/vdp.a"

.init_io
    +SetVector .chrout, CSWL
    +SetVector .getkey, KSWL
    bra init_vdp
   
.chrout
    pha
    phx
    and #$7f
    jsr vdp_chrout
    cmp #$0d
    bne +
    lda #$0a            ;mac specific, newline with CR is just a $0d, the vdp_chrout is "windows/dos" conform therefore we explicitly send a $0a
    jsr vdp_chrout
+   plx
    pla
    rts 
	
.getkey
	phx
-	lda #%01111010
	sta via1portb
	jsr .spi_r_byte
;    cmp #$00; restore zero flag
	ldx #%11111110
	stx via1portb
    cmp #$00
    beq -
	plx
    ora #$80; apple specific, bit 7 key pressed
    rts 
