*=$1000
!src <defs.h.a>
!src <bios.h.a>
!src <t9929.h.a>


; 	system attribute has to be set on file system

!address {
	.dest = $e000
	.bios = $f000	
}

; .pages = (.payload_end - .payload) / 256 + 1

	stz memctl

	; copy kernel code to $e000

-	
a	lda .payload
b	sta .dest

	inc a+1
	inc b+1
	bne -

	lda a+2
	cmp #>.payload_end
	bne +
	
	lda a+1
	cmp #<.payload_end
	bne +
	bra ++
+
	inc a+2
	inc b+2
	bne -

++

; copy bios to underlying ram
-
a2	lda .bios
b2	sta .bios

	inc a2+1
	inc b2+1
	bne -

	inc a2+2
	inc b2+2
	bne -

	;display off
	lda		#v_reg1_16k	;enable 16K ram, disable screen
	sta 	a_vreg
	+vnops
	lda	  	#v_reg1
	sta   	a_vreg
	

	; copy 6x8 charset to vdp ram 
	+SetVector	.charset, adrl	;load charset
	lda	#<ADDRESS_GFX1_PATTERN
	
	ldy	#.WRITE_ADDRESS + >ADDRESS_GFX1_PATTERN
	ldx	#$08					

	+vdp_sreg
	
	ldy   #$00
-  	lda   (adrl),y

	+vnops

	iny
	sta   a_vram
	bne   -
	inc   adrh
	dex
	bne   -
	


	lda #$01
	sta memctl


	; +vnops

	
	jmp .dest
	
!align 255,0
; *=$1100
.payload
!bin "kernel.bin"
.payload_end

; !align 255,0
.charset
;!src "../../charsets/char.ascii.vc20.6x8.h.a"
!src "../../charsets/ati_smallw_6x8.h.a"
.charset_end

; !src "../lib/t99xx.lib.a"
